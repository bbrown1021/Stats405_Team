---
title: "R Notebook"
author: "Harrison DiStefano"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

# Final Project EDA 

```{r}
# Libraries
#install.packages("RMariaDB")
library(RMariaDB)
library(DBI)
library(ggplot2)
```

```{r}
# Connect to database
db_host <- Sys.getenv("DB_READ_ENDPOINT")
db_user <- Sys.getenv("DB_READ_USER")
db_pw   <- Sys.getenv("DB_READ_PASSWORD")
db_port <- Sys.getenv("DB_READ_PORT")
db_name <- Sys.getenv("DB_READ_DB")
db_drv  <- RMariaDB::MariaDB()

con <- dbConnect(db_drv, user=db_user, password=db_pw, dbname=db_name, host=db_host, port=db_port)

dbListTables(con)
```
```{r}
# Take a look at the first few rows
query1 <- "
SELECT * 
FROM music
LIMIT 10

;
"

result1 <- dbGetQuery(con, query1)
result1
```
```{r}
query2 <- "
SELECT speechiness, instrumentalness, energy
FROM music

;
"

result2 <- dbGetQuery(con, query2)
```

```{r}
ggplot(data = result2, mapping = aes(x = speechiness, y = instrumentalness, col = energy)) +
  geom_point(size = 1)
```
Most of the tracks displaying a high degree of speechiness have 0 instrumentalness, probably indicating they are audio books, podcasts, spoken word, etc. 

There are a few outliers that have both high speechiness and instrumentalness (> 0.5 for both) which is interesting because from the variable descriptions these seem mutually exclusive.

More energetic tracks clustered more around the extremes of instrumental and spechiness?

Let's take a closer look at the outliers:
```{r}
query3 <- "
SELECT artist, track, speechiness, instrumentalness
FROM music
WHERE speechiness > 0.5 AND instrumentalness > 0.5
ORDER BY speechiness DESC

;
"

result3 <- dbGetQuery(con, query3)
result3
```
Listening to these tracks, most have very little actual vocalization but are generally noisy. It's possible Spotify's algorithm is mistaking some of the cacophonous sounds as voices.


```{r}
query4 <- "
SELECT CASE WHEN song_key = 0 THEN 'C'
            WHEN song_key = 1 THEN 'C#/Db'
            WHEN song_key = 2 THEN 'D'
            WHEN song_key = 3 THEN 'D#/Eb'
            WHEN song_key = 4 THEN 'E'
            WHEN song_key = 5 THEN 'F'
            WHEN song_key = 5 THEN 'F#/Gb'
            WHEN song_key = 6 THEN 'G'
            WHEN song_key = 7 THEN 'G#/Ab'
            WHEN song_key = 8 THEN 'A'
            WHEN song_key = 9 THEN 'A#/Bb'
            WHEN song_key = 10 THEN 'B'
            ELSE 'Unknown Key'
       END,
       CASE WHEN song_mode = 0 THEN 'minor'
            WHEN song_mode = 1 THEN 'major'
            ELSE 'Unknown Mode'
       END
FROM music
                     
;
"

result4 <- dbGetQuery(con, query4)
names(result4) <- c("key", "mode")

ggplot(data = result4, aes(x = key, group = mode, fill = mode, stat = "count")) +
  geom_bar(position = "dodge") +
  labs(title = "Frequency of Keys Assigned by Spotify")
```
Spotify assigned most songs to a major key which makes sense because most songs are written in major keys.

C, D, and G#/Ab (probably Ab, G# is awkward) major are the most commonly found keys. Generally keys with less accidentals (#/b) keys are more popular--the two most popular keys C major and D major have 0 and 2 respectively.

Around 2800 tracks are of unknown key, or about 7% of the database. 


```{r}
# Disconnect from database to clean up connection
dbDisconnect(con)
```
